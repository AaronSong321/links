# Currently, there is a bug in Links' effect system which prevents this example from running
# Coroutines in Links

typename Thread = forall r::Row . () ~r~> ();

fun start(m) { do Spawn(m) }
fun yield()  { do Yield() }

handler queue(m) {
     case Enqueue(p,k) -> fun(q) {
                           k(())(q ++ [p])
                          }
     case Dequeue(_,k) -> fun(q) {
			    k(hd(q))(tl(q))
                          }
     case Peek(_,k)    -> fun(q) {
     	  	       	     k(q)(q)
                          }
     case Return(x)    -> fun(q) { x }			  
}

open handler scheduler(m) {
      case Spawn(t : Thread,k) -> { var q = do Enqueue(k); t() }
      case Yield(_,k) -> { var q = do Enqueue(k); var t = do Dequeue() : Thread; t() }
      case Return(x)  -> x
}

handler test(m) {
      case Op(t,k)    -> test(t)
      case Return(x)  -> x
}

fun comp() {
    start(fun() {
       fold_left(fun(a,b) {
       	   print("a");
	   yield()
	 }, (), [1..6])
    });
    start(fun() {
       fold_left(fun(a,b) {
       	   print("b");
	   yield()
	 }, (), [1..6])                
    })
}
